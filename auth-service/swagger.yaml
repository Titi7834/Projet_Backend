openapi: 3.0.3
info:
  title: Auth Service API
  description: Service d'authentification et de gestion des utilisateurs
  version: 1.0.0
  contact:
    name: API Support

servers:
  - url: http://localhost:4000
    description: Serveur de développement
  - url: http://localhost:3000
    description: Serveur interne (Docker)

tags:
  - name: Authentication
    description: Endpoints d'authentification
  - name: Users
    description: Gestion des utilisateurs
  - name: Admin
    description: Administration (réservé aux ADMIN)

paths:
  /health:
    get:
      summary: Health check
      description: Vérifier l'état de santé du service
      tags:
        - Health
      responses:
        '200':
          description: Service opérationnel
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  service:
                    type: string
                    example: auth-service
                  timestamp:
                    type: string
                    format: date-time

  /auth/register:
    post:
      summary: Créer un compte utilisateur
      description: Inscription d'un nouvel utilisateur
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - username
                - password
              properties:
                email:
                  type: string
                  format: email
                  example: user@example.com
                username:
                  type: string
                  minLength: 3
                  maxLength: 50
                  example: john_doe
                password:
                  type: string
                  minLength: 6
                  example: password123
      responses:
        '201':
          description: Utilisateur créé avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Utilisateur créé avec succès
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Email ou username déjà utilisé

  /auth/login:
    post:
      summary: Se connecter
      description: Authentification avec email/username et mot de passe
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - login
                - password
              properties:
                login:
                  type: string
                  description: Email ou username
                  example: user@example.com
                password:
                  type: string
                  example: password123
      responses:
        '200':
          description: Connexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Connexion réussie
                  user:
                    $ref: '#/components/schemas/User'
                  token:
                    type: string
                    example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        '401':
          $ref: '#/components/responses/Unauthorized'

  /auth/me:
    get:
      summary: Récupérer le profil de l'utilisateur connecté
      description: Obtenir les informations de l'utilisateur authentifié
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Profil utilisateur
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/admin/users:
    get:
      summary: Récupérer tous les utilisateurs
      description: Liste de tous les utilisateurs (ADMIN uniquement)
      tags:
        - Admin
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Liste des utilisateurs
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'

  /api/users/{id}/role:
    patch:
      summary: Modifier le rôle d'un utilisateur
      description: Changer le rôle d'un utilisateur (ADMIN ou service interne)
      tags:
        - Admin
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID de l'utilisateur
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - role
              properties:
                role:
                  type: string
                  enum: [USER, EXPERT, ADMIN]
                  example: EXPERT
      responses:
        '200':
          description: Rôle modifié avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Rôle modifié avec succès
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /api/users/{id}/reputation:
    patch:
      summary: Modifier la réputation d'un utilisateur
      description: Mettre à jour la réputation (service interne)
      tags:
        - Users
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
          description: ID de l'utilisateur
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - reputation
              properties:
                reputation:
                  type: number
                  minimum: 0
                  example: 150
      responses:
        '200':
          description: Réputation modifiée avec succès
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Réputation modifiée avec succès
                  user:
                    $ref: '#/components/schemas/User'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    User:
      type: object
      properties:
        _id:
          type: string
          example: 507f1f77bcf86cd799439011
        email:
          type: string
          format: email
          example: user@example.com
        username:
          type: string
          example: john_doe
        role:
          type: string
          enum: [USER, EXPERT, ADMIN]
          example: USER
        reputation:
          type: number
          minimum: 0
          example: 0
        createdAt:
          type: string
          format: date-time
        deletedAt:
          type: string
          format: date-time
          nullable: true
        deletedBy:
          type: string
          nullable: true

    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: Une erreur est survenue

  responses:
    BadRequest:
      description: Requête invalide
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Données invalides

    Unauthorized:
      description: Non authentifié
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Token manquant ou invalide

    Forbidden:
      description: Accès interdit
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Accès réservé aux administrateurs

    NotFound:
      description: Ressource non trouvée
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            success: false
            message: Utilisateur non trouvé
